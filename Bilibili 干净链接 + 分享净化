// ==UserScript==
// @name         Bilibili 干净链接 + 分享净化
// @namespace    Motoori Kashin
// @version      3.1.0
// @description  清理 B 站链接垃圾参数，点击分享按钮复制干净链接
// @author       ChatGPT+Bart
// @match        *://*.bilibili.com/*
// @grant        none
// @run-at       document-start
// @icon         https://www.bilibili.com/favicon.ico
// ==/UserScript==

(function () {
    'use strict';

    // -------------------- URL 清理逻辑 --------------------
    const paramsSet = new Set([
        'spm_id_from','from_source','msource','bsource','seid','source','session_id','visit_id',
        'sourceFrom','from_spmid','share_source','share_medium','share_plat','share_session_id',
        'share_tag','unique_k','csource','vd_source','tab','is_story_h5','share_from','plat_id',
        '-Arouter','spmid'
    ]);

    function cleanURL(str) {
        try {
            const url = new URL(str, location.origin);
            paramsSet.forEach(p => url.searchParams.delete(p));
            return url.toString();
        } catch(e) {
            return str;
        }
    }

    function cleanLocation() {
        const cleanHref = cleanURL(location.href);
        if (location.href !== cleanHref) {
            history.replaceState(history.state, "", cleanHref);
        }
    }

    function cleanAnchors(list) {
        list.forEach(a => {
            if (a.href) {
                a.href = a.href.replace('bilibili.tv', 'bilibili.com'); // tv域名修复
                a.href = cleanURL(a.href);
            }
        });
    }

    function clickHandler(e) {
        let t = e.target;
        while(t && t.tagName !== 'A') t = t.parentNode;
        if (t && t.tagName === 'A') cleanAnchors([t]);
    }

    // -------------------- clipboard 劫持 --------------------
    const originalWriteText = navigator.clipboard.writeText.bind(navigator.clipboard);
    navigator.clipboard.writeText = async function(text) {
        if (typeof text === 'string' && text.includes('bilibili.com')) {
            text = text.replace(/([&?])(share_source|vd_source)=[^&]*/g, (m,p1)=>p1==='?'?'?':'');
            text = text.replace(/&+/g,'&').replace(/\?&/,'?').replace(/[&?]$/,'');
        }
        return originalWriteText(text);
    };



    // -------------------- MutationObserver --------------------
    const observer = new MutationObserver(() => {
        cleanLocation();
        cleanAnchors(document.querySelectorAll('a'));
        observeShareButtons();
    });

    observer.observe(document, { childList: true, subtree: true });

    // -------------------- 全局事件绑定 --------------------
    window.addEventListener('click', clickHandler);
    window.addEventListener('contextmenu', clickHandler);

    // 页面加载时处理一次
    window.addEventListener('load', () => {
        cleanLocation();
        cleanAnchors(document.querySelectorAll('a'));
        observeShareButtons();
    });

    console.log('Bilibili 干净链接 + 分享净化脚本已加载');
})();
